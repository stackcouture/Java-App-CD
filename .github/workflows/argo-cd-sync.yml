name: Argo CD Sync

on:
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Argo CD CLI
        run: |
          curl -sSL https://github.com/argoproj/argo-cd/releases/download/v2.5.3/argocd-linux-amd64 -o /usr/local/bin/argocd
          chmod +x /usr/local/bin/argocd

      - name: Verify Argo CD token auth
        env:
          ARGOCD_SERVER: ${{ secrets.ARGOCD_SERVER }}
          ARGOCD_API_TOKEN: ${{ secrets.ARGOCD_API_TOKEN }}
        run: |
          echo "Getting user info using token..."
          argocd account get-user-info \
            --server $ARGOCD_SERVER \
            --auth-token $ARGOCD_API_TOKEN \
            --insecure

      - name: Sync app
        env:
          ARGOCD_SERVER: ${{ secrets.ARGOCD_SERVER }}
          ARGOCD_API_TOKEN: ${{ secrets.ARGOCD_API_TOKEN }}
        run: |
          argocd app sync <your-app-name> \
            --server $ARGOCD_SERVER \
            --auth-token $ARGOCD_API_TOKEN \
            --insecure
